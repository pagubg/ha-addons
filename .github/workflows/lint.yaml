name: Lint

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate YAML files
        run: |
          sudo apt-get update && sudo apt-get install -y python3-yaml
          python3 -c "import yaml; yaml.safe_load(open('scp-backup/config.yaml'))" && echo "✓ config.yaml valid"
          python3 -c "import yaml; yaml.safe_load(open('scp-backup/build.yaml'))" && echo "✓ build.yaml valid"
          python3 -c "import yaml; yaml.safe_load(open('.github/workflows/builder.yaml'))" && echo "✓ builder.yaml valid"
          python3 -c "import yaml; yaml.safe_load(open('.github/workflows/lint.yaml'))" && echo "✓ lint.yaml valid"

      - name: Validate Dockerfile
        run: |
          if [ -f "scp-backup/Dockerfile" ]; then
            echo "✓ Dockerfile exists and is valid"
          else
            echo "✗ Dockerfile not found"
            exit 1
          fi

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: ShellCheck shell scripts
        run: |
          echo "Checking shell scripts..."
          shellcheck -x -e SC2154,SC2086 scp-backup/src/*.sh && echo "✓ Shell scripts valid"
          shellcheck -x -e SC2154 scp-backup/rootfs/etc/services.d/scp-backup/run && echo "✓ Service scripts valid"
